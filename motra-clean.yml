---
- name: Cleanup Docker and remove motra working directory
  hosts: all
  become: true
  vars_files:
    - vars/prod.yml

  roles:
    - role: motra_clean
      tags: motra_clean
    - role: motra
      tags: motra

- name: Start monitoring stack on server
  hosts: rpiserver
  become: true
  become_user: las3
  tasks:
    - name: Bring up monitoring profile on plc stack
      ansible.builtin.shell: docker compose -f plc.yml --profile monitoring up -d
      args:
        chdir: /home/las3/motra/simple-water-treatment-plant/multi-dev
      tags:
        - motra_up

- name: Start plant services on client
  hosts: rpiclient
  become: true
  become_user: las3
  tasks:
    - name: Bring up plant stack
      ansible.builtin.shell: docker compose -f levelsensor-server.yml -f headunit.yml -f monitoring.yml -f valve-server.yml up -d
      args:
        chdir: /home/las3/motra/simple-water-treatment-plant/multi-dev
      tags:
        - motra_up
