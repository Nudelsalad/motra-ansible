---
- name: Install perf tools for specific kernel
  apt:
    name: "linux-tools-{{ kernel_version }}"
    state: present

- name: Install systemd slices from role files
  become: true
  copy:
    src: "systemd/{{ item }}"
    dest: "/etc/systemd/system/{{ item }}"
    mode: "0644"
  loop:
    - isolated.slice
    - workloads.slice

- name: Reload systemd to pick up slice units
  become: true
  systemd:
    daemon_reload: yes

- name: Ensure slices are started
  become: true
  systemd:
    name: "{{ item }}"
    state: started
  loop:
    - isolated.slice
    - workloads.slice

- name: Ensure kernel.perf_event_paranoid is set
  become: true
  sysctl:
    name: kernel.perf_event_paranoid
    value: "-1"
    state: present
    reload: yes

- name: Append cgroup kernel params to cmdline
  replace:
    path: "/boot/firmware/cmdline.txt"
    regexp: "^(.*)$"
    replace: '\\1 cgroup_enable=cpuset cgroup_enable=memory cgroup_memory=1'

- name: Reboot after kernel install
  reboot:
    msg: "Rebooting after kernel installation"
    reboot_timeout: 600

- name: Show running kernel
  debug:
    msg: "Running kernel: {{ uname_out.stdout }}"

