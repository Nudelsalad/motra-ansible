---
- name: Check if swap is already active
  command: swapon --show --noheadings --raw
  register: swap_show
  changed_when: false
  failed_when: false

- name: Ensure swapfile present when none active
  when: swap_show.stdout | trim == ''
  block:
    - name: Create swap file with fallocate
      command: fallocate -l {{ swap_size_mib }}M {{ swap_file }}
      args:
        creates: "{{ swap_file }}"
      register: fallocate_result
      failed_when: false

    - name: Create swap file with dd if fallocate failed
      command: dd if=/dev/zero of={{ swap_file }} bs=1M count={{ swap_size_mib }} conv=fsync
      when: fallocate_result.rc is defined and fallocate_result.rc != 0

    - name: Set swap file permissions
      file:
        path: "{{ swap_file }}"
        mode: '0600'

    - name: Make swap
      command: mkswap {{ swap_file }}
      args:
        creates: "{{ swap_file }}.mkswap_done"
      register: mkswap_result
      changed_when: mkswap_result.rc == 0

    - name: Activate swap
      command: swapon {{ swap_file }}
