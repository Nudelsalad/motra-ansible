---
- name: Define scxctl binary path
  set_fact:
    scxctl_bin_path: "/home/{{ motra_user }}/.cargo/bin/scxctl"
  tags: [scheduler, sched_test]

- name: Ensure SCENARIO and SCHEDULER are set in compose .env
  become: true
  become_user: "{{ motra_user }}"
  lineinfile:
    path: "{{ sched_test_workdir }}/.env"
    regexp: "^{{ env_var.key }}="
    line: "{{ env_var.key }}={{ env_var.value }}"
    create: yes
  loop:
    - { key: "SCHEDULER", value: "{{ sched_test_scheduler }}" }
  loop_control:
    loop_var: env_var
  tags: [env, sched_test]

- name: Compute effective run duration
  set_fact:
    sched_test_effective_duration: "{{ (sched_test_attack | bool) | ternary(sched_test_attack_duration, sched_test_heavy_load_duration) }}"
  tags: [summary, sched_test]

- name: Show run profile summary (one line)
  ansible.builtin.debug:
    msg: "RUN PROFILE: scheduler={{ sched_test_scheduler }} attack={{ sched_test_attack }} (service={{ sched_test_attack_service }}) heavy_load={{ sched_test_heavy_load }} duration={{ sched_test_effective_duration }}s on {{ inventory_hostname }} (attacker on {{ sched_test_attack_delegate | default(inventory_hostname) }}, heavy on {{ inventory_hostname }})"
  tags: [summary, sched_test]

- name: Append run profile to history log on server
  become: true
  become_user: "{{ motra_user }}"
  ansible.builtin.shell: |
    echo "$(date -Is) scheduler={{ sched_test_scheduler }} attack={{ sched_test_attack }} heavy_load={{ sched_test_heavy_load }} duration={{ sched_test_effective_duration }}s host={{ inventory_hostname }} attacker={{ sched_test_attack_delegate | default(inventory_hostname) }} heavy_host={{ inventory_hostname }}" >> run-history.log
  args:
    chdir: "{{ sched_test_workdir }}"
    executable: /bin/bash
  tags: [summary, sched_test]

- name: Manage scheduler switching
  block:
    - name: Reset fallback flag
      set_fact:
        sched_test_fallback_needed: false

    - name: Stop sched_ext scheduler if running
      become: true
      ansible.builtin.command:
        argv:
          - "{{ scxctl_bin_path }}"
          - stop
      register: scxctl_stop
      changed_when: "scxctl_stop.rc == 0"
      failed_when: false

    - name: Derive scheduler name for scxctl (strip scx_ prefix)
      set_fact:
        sched_test_loader_name: "{{ (sched_test_scheduler | lower) | regex_replace('^scx_', '') }}"
      when: sched_test_scheduler | lower != 'cfs'

    - name: Start scheduler via scxctl
      become: true
      ansible.builtin.command:
        argv:
          - "{{ scxctl_bin_path }}"
          - start
          - -s
          - "{{ sched_test_loader_name | default(sched_test_scheduler | lower) }}"
      register: scx_start_result
      changed_when: "scx_start_result.rc == 0"
      failed_when: false
      when:
        - sched_test_scheduler | lower != 'cfs'

    - name: Decide if fallback to direct scheduler binary is needed
      set_fact:
        sched_test_fallback_needed: true
      when:
        - sched_test_scheduler | lower != 'cfs'
        - scx_start_result.rc | default(0) != 0

    - name: Compute direct scheduler binary path
      set_fact:
        sched_test_scheduler_bin: "/home/{{ motra_user }}/.cargo/bin/scx_{{ sched_test_loader_name | default(sched_test_scheduler | lower) }}"
      when: sched_test_fallback_needed | default(false)

    - name: Check if direct scheduler binary exists
      stat:
        path: "{{ sched_test_scheduler_bin }}"
      register: sched_bin_stat
      when: sched_test_fallback_needed | default(false)

    - name: Start scheduler directly as background process (fallback)
      become: true
      ansible.builtin.shell: |
        set -euo pipefail
        nohup "{{ sched_test_scheduler_bin }}" >"/tmp/{{ sched_test_loader_name | default(sched_test_scheduler | lower) }}.log" 2>&1 & echo $! > "/tmp/{{ sched_test_loader_name | default(sched_test_scheduler | lower) }}.pid"
      args:
        executable: /bin/bash
      when:
        - sched_test_fallback_needed | default(false)
        - sched_bin_stat.stat.exists | default(false)
      register: sched_fallback_start
      changed_when: true

    - name: Warn when no direct scheduler binary found
      meta: noop
      when:
        - sched_test_fallback_needed | default(false)
        - not (sched_bin_stat.stat.exists | default(false))

    - name: Stabilize after scheduler switch
      ansible.builtin.wait_for:
        timeout: 5

  when: sched_test_switch_scheduler
  tags: [scheduler, sched_test]
# -----------------------------------------------------------------
# END OF SCHEDULER BLOCK
# -----------------------------------------------------------------

# -----------------------------------------------------------------
# BLOCK FOR TEST RUN WITH GUARANTEED CLEANUP
# -----------------------------------------------------------------
- name: Run test scenario with guaranteed cleanup
  block:
    - name: Bring up only monitoring services on plc stack (cadvisor, redis)
      become: true
      become_user: "{{ motra_user }}"
      ansible.builtin.shell: |
        set -euo pipefail
        docker compose -f plc.yml up -d --force-recreate --remove-orphans cadvisor redis
      args:
        chdir: "{{ sched_test_workdir }}"
        executable: /bin/bash
      tags: [compose, server, monitoring, sched_test]

    - name: Wait for services to settle
      ansible.builtin.wait_for:
        timeout: "{{ sched_test_wait_after_up }}"
      tags: [wait, sched_test]

    - name: Ensure kernel build dependencies on Debian/Ubuntu (server)
      when:
        - sched_test_heavy_load | bool
        - ansible_os_family == "Debian"
      block:
        - name: Install core kernel build packages
          become: true
          ansible.builtin.apt:
            name: "{{ sched_test_kernel_packages_core }}"
            state: present
            update_cache: yes
          tags: [heavy, deps, sched_test]

    - name: Warn when OS family is not Debian for heavy load deps
      ansible.builtin.debug:
        msg: "Heavy load requested on non-Debian OS family ({{ ansible_os_family }}); kernel build deps not auto-installed."
      when:
        - sched_test_heavy_load | bool
        - ansible_os_family != "Debian"
      tags: [heavy, deps, sched_test]

    - name: Capture run start timestamp (ms)
      ansible.builtin.command: date +%s%3N
      register: sched_test_run_start_cmd
      changed_when: false
      args:
        executable: /bin/bash
      tags: [run, sched_test]

    - name: Set run start fact
      set_fact:
        sched_test_run_start_ms: "{{ sched_test_run_start_cmd.stdout | int }}"
      tags: [run, sched_test]

    - name: Check for kernel source for heavy load (server)
      stat:
        path: "{{ sched_test_kernel_src }}"
      register: kernel_src_stat
      when: sched_test_heavy_load | bool
      tags: [heavy, sched_test]

    - name: Stop lingering kernel build before starting new one
      become: true
      become_user: "{{ motra_user }}"
      ansible.builtin.shell: |
        set -euo pipefail
        if [ -f /tmp/kernel-build.pid ]; then
          target_pid="$(cat /tmp/kernel-build.pid)"
          if [ -n "$target_pid" ] && kill -0 "$target_pid" 2>/dev/null; then
            target_comm="$(ps -p "$target_pid" -o comm= 2>/dev/null || true)"
            if [ "$target_comm" = "make" ]; then
              kill -9 "$target_pid" || true
            fi
          fi
          rm -f /tmp/kernel-build.pid
        fi
        pkill -9 -u "{{ motra_user }}" -x make || true
      args:
        executable: /bin/bash
      when:
        - sched_test_heavy_load | bool
        - kernel_src_stat.stat.isdir | default(false)
      tags: [heavy, cleanup, sched_test]

    - name: Clean kernel tree before heavy load
      become: true
      become_user: "{{ motra_user }}"
      ansible.builtin.shell: |
        set -euo pipefail
        make clean || true
      args:
        chdir: "{{ sched_test_kernel_src }}"
        executable: /bin/bash
      when:
        - sched_test_heavy_load | bool
        - kernel_src_stat.stat.isdir | default(false)
      tags: [heavy, prepare, sched_test]

    - name: Start heavy load (kernel build) on server
      become: true
      become_user: "{{ motra_user }}"
      ansible.builtin.shell: |
        set -euo pipefail
        cd "{{ sched_test_kernel_src }}"
        KERNEL={{ sched_test_kernel_name }} make {{ sched_test_kernel_defconfig }}
        KERNEL={{ sched_test_kernel_name }} nice -n {{ sched_test_heavy_load_nice }} make -j{{ sched_test_kernel_make_jobs }} {{ sched_test_kernel_targets }} \
          1>"/tmp/kernel-build.out" 2>"/tmp/kernel-build.err" & echo $! > "/tmp/kernel-build.pid"
      args:
        executable: /bin/bash
      when:
        - sched_test_heavy_load | bool
        - kernel_src_stat.stat.isdir | default(false)
      tags: [heavy, sched_test]

    - name: Warn if kernel source missing on server
      ansible.builtin.debug:
        msg: "Heavy load requested but kernel source not found at {{ sched_test_kernel_src }} on {{ inventory_hostname }} â€” skipping heavy load."
      when:
        - sched_test_heavy_load | bool
        - not (kernel_src_stat.stat.isdir | default(false))
      tags: [heavy, sched_test]

    - name: Start attack '{{ sched_test_attack_service }}' on delegate (client) when enabled
      become: true
      become_user: "{{ motra_user }}"
      ansible.builtin.shell: |
        set -euo pipefail
        docker compose -p attacker -f attacker.yml up -d {{ sched_test_attack_service }}
      args:
        chdir: "{{ sched_test_workdir }}"
        executable: /bin/bash
      delegate_to: "{{ sched_test_attack_delegate | default(inventory_hostname) }}"
      when:
        - sched_test_attack | bool
      tags: [attack, sched_test]

    - name: Optional pre-attack wait
      ansible.builtin.wait_for:
        timeout: "{{ sched_test_wait_before_attack }}"
      when: sched_test_attack | bool
      tags: [wait, sched_test]

    - name: Run for duration (server)
      ansible.builtin.wait_for:
        timeout: "{{ sched_test_effective_duration }}"
      tags: [run, sched_test]

    - name: Capture run end timestamp (ms)
      ansible.builtin.command: date +%s%3N
      register: sched_test_run_end_cmd
      changed_when: false
      args:
        executable: /bin/bash
      tags: [run, sched_test]

    - name: Set run end fact
      set_fact:
        sched_test_run_end_ms: "{{ sched_test_run_end_cmd.stdout | int }}"
      tags: [run, sched_test]

  always:
    - name: Stop heavy load on server (cleanup)
      become: true
      become_user: "{{ motra_user }}"
      ansible.builtin.shell: |
        set -euo pipefail
        if [ -f /tmp/kernel-build.pid ]; then
          target_pid="$(cat /tmp/kernel-build.pid)"
          if [ -n "$target_pid" ] && kill -0 "$target_pid" 2>/dev/null; then
            target_comm="$(ps -p "$target_pid" -o comm= 2>/dev/null || true)"
            if [ "$target_comm" = "make" ]; then
              kill -9 "$target_pid" || true
            fi
          fi
          rm -f /tmp/kernel-build.pid
        fi
        pkill -9 -u "{{ motra_user }}" -x make || true
      args:
        executable: /bin/bash
      when: sched_test_heavy_load | bool
      tags: [heavy, cleanup, sched_test]

    - name: Clean kernel build artifacts on server
      become: true
      become_user: "{{ motra_user }}"
      ansible.builtin.shell: |
        set -euo pipefail
        make clean || true
      args:
        chdir: "{{ sched_test_kernel_src }}"
        executable: /bin/bash
      when:
        - sched_test_heavy_load | bool
        - kernel_src_stat is defined
        - kernel_src_stat.stat.isdir | default(false)
      tags: [heavy, cleanup, sched_test]

    - name: Remove kernel build logs
      become: true
      become_user: "{{ motra_user }}"
      ansible.builtin.file:
        path: "/tmp/{{ log_file }}"
        state: absent
      loop:
        - kernel-build.out
        - kernel-build.err
      loop_control:
        loop_var: log_file
      when: sched_test_heavy_load | bool
      tags: [heavy, cleanup, sched_test]
    - name: Stop attack '{{ sched_test_attack_service }}' container on delegate (cleanup)
      become: true
      become_user: "{{ motra_user }}"
      ansible.builtin.docker_container:
        name: "{{ sched_test_attack_service }}"
        state: absent
        force_kill: yes
      delegate_to: "{{ sched_test_attack_delegate | default(inventory_hostname) }}"
      when:
        - sched_test_attack | bool
        - sched_test_stop_attack_after | bool
      tags: [attack, cleanup, sched_test]
