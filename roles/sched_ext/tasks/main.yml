---
- name: Install dependencies for sched-ext
  apt:
    name:
      - build-essential
      - bpftool
      - libelf-dev
      - libzstd-dev
      - pkg-config
      - ca-certificates
      - zlib1g-dev
      - gnupg
      - curl
      - wget
      - libseccomp-dev
      - git
      - rsync
    state: present
    update_cache: yes

- name: Install LLVM toolchain 20
  shell: |
    set -e
    export DEBIAN_FRONTEND=noninteractive
    curl -sSL https://apt.llvm.org/llvm.sh | bash -s -- 20 all
  args:
    executable: /bin/bash
    creates: /usr/bin/clang-20

- name: Query clang alternative
  command: update-alternatives --query clang
  register: clang_alternative
  failed_when: clang_alternative.rc not in [0, 2]
  changed_when: false

- name: Ensure clang alternative points to clang-20
  command: update-alternatives --install /usr/bin/clang clang /usr/bin/clang-20 200
  when: clang_alternative.rc != 0 or ('/usr/bin/clang-20' not in (clang_alternative.stdout | default('')))

- name: Query clang++ alternative
  command: update-alternatives --query clang++
  register: clangxx_alternative
  failed_when: clangxx_alternative.rc not in [0, 2]
  changed_when: false

- name: Ensure clang++ alternative points to clang++-20
  command: update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-20 200
  when: clangxx_alternative.rc != 0 or ('/usr/bin/clang++-20' not in (clangxx_alternative.stdout | default('')))

- name: Query llvm-strip alternative
  command: update-alternatives --query llvm-strip
  register: llvmstrip_alternative
  failed_when: llvmstrip_alternative.rc not in [0, 2]
  changed_when: false

- name: Ensure llvm-strip alternative points to llvm-strip-20
  command: update-alternatives --install /usr/bin/llvm-strip llvm-strip /usr/bin/llvm-strip-20 200
  when: llvmstrip_alternative.rc != 0 or ('/usr/bin/llvm-strip-20' not in (llvmstrip_alternative.stdout | default('')))

- name: Build and install libbpf {{ scx_libbpf_version | default('1.5.0') }} from source
  shell: |
    set -e
    LIBBPF_VERSION="{{ scx_libbpf_version | default('1.5.0') }}"
    TMPDIR="$(mktemp -d)"
    trap 'rm -rf "$TMPDIR"' EXIT
    curl -sSL "https://github.com/libbpf/libbpf/archive/refs/tags/v${LIBBPF_VERSION}.tar.gz" \
      | tar -xz --strip-components=1 -C "$TMPDIR"
    make -C "$TMPDIR/src"
    make -C "$TMPDIR/src" install PREFIX=/usr/local LIBDIR=/usr/local/lib
    make -C "$TMPDIR/src" install_headers PREFIX=/usr/local
    make -C "$TMPDIR/src" install_pkgconfig PREFIX=/usr/local LIBDIR=/usr/local/lib
    ldconfig
  args:
    executable: /bin/bash
    creates: /usr/local/lib/pkgconfig/libbpf.pc

- name: Check for existing rustup installation
  become: true
  become_user: "{{ sched_ext_user }}"
  command: command -v rustup
  register: rustup_check
  changed_when: false
  failed_when: false

- name: Install rustup for {{ sched_ext_user }}
  become: true
  become_user: "{{ sched_ext_user }}"
  shell: |
    set -euo pipefail
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain nightly
  args:
    executable: /bin/bash
  environment:
    HOME: "/home/{{ sched_ext_user }}"
  when: rustup_check.rc != 0

- name: Ensure cargo bin is in PATH
  become: true
  become_user: "{{ sched_ext_user }}"
  lineinfile:
    path: "/home/{{ sched_ext_user }}/.profile"
    line: 'export PATH="$HOME/.cargo/bin:$PATH"'
    create: yes
    state: present

- name: Clone scx repository (optional, for reference/examples)
  git:
    repo: https://github.com/sched-ext/scx.git
    dest: "{{ scx_clone_dir }}"
    version: "{{ scx_version }}"
    force: yes
  when: scx_clone_repo | bool

- name: Install sched-ext schedulers and tools from crates.io
  become: true
  become_user: "{{ sched_ext_user }}"
  shell: |
    set -euo pipefail
    export PATH="$HOME/.cargo/bin:$PATH"
    cargo install {{ item }}
  args:
    executable: /bin/bash
  environment:
    HOME: "/home/{{ sched_ext_user }}"
  loop: "{{ scx_crates_to_install }}"
  when: scx_crates_to_install | length > 0
