---
- name: Install dependencies for sched-ext
  apt:
    name:
      - build-essential
      - bpftool
      - libbpf-dev
      - libelf-dev
      - libzstd-dev
      - pkg-config
      - clang
      - llvm
      - ca-certificates
      - zlib1g-dev
      - gnupg
      - curl
      - wget
      - libseccomp-dev
      - git
    state: present
    update_cache: yes

- name: Determine sched-ext target user
  set_fact:
    sched_ext_user_resolved: "{{ sched_ext_user | default(ansible_user) }}"

- name: Discover home directory for {{ sched_ext_user_resolved }}
  command: getent passwd {{ sched_ext_user_resolved }}
  register: sched_ext_passwd_entry
  changed_when: false

- name: Set sched-ext home directory fact
  set_fact:
    sched_ext_home: "{{ sched_ext_passwd_entry.stdout.split(':')[5] }}"

- name: Ensure rustup and cargo present for {{ sched_ext_user_resolved }}
  become: true
  become_user: "{{ sched_ext_user_resolved }}"
  shell: |
    set -e
    export HOME="{{ sched_ext_home }}"
    export PATH="$HOME/.cargo/bin:$PATH"
    if ! command -v rustup >/dev/null 2>&1; then
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain 1.82.0
    else
      rustup toolchain install 1.82.0
    fi
  args:
    executable: /bin/bash
- name: Create remote scx directory
  file:
    path: "{{ scx_remote_dir }}"
    state: directory
    mode: '0755'

- name: Clone scx repository at specified version
  git:
    repo: https://github.com/sched-ext/scx.git
    dest: "{{ scx_remote_dir }}"
    version: "{{ scx_version | default('v1.0.17') }}"
    force: yes
    recursive: yes
    update: yes
    accept_hostkey: yes

- name: Install C schedulers
  make:
    chdir: "{{ scx_remote_dir }}"
    target: install
    params:
      INSTALL_DIR: "{{ scx_install_dir }}"

- name: Ensure cargo bin path is present for {{ sched_ext_user_resolved }}
  become: true
  become_user: "{{ sched_ext_user_resolved }}"
  lineinfile:
    path: "{{ sched_ext_home }}/.profile"
    line: 'export PATH="$HOME/.cargo/bin:$PATH"'
    create: yes
    state: present

- name: Install Rust schedulers
  become: true
  become_user: "{{ sched_ext_user_resolved }}"
  shell: |
    set -e
    export PATH="$HOME/.cargo/bin:$PATH"
    cd {{ scx_remote_dir }}
    ls -d scheds/rust/scx_* | xargs -I{} cargo install --locked --path {}
  args:
    executable: /bin/bash
  when: install_rust_schedulers | bool
