---
- name: Create remote temp directory
  tempfile:
    state: directory
    suffix: kernel
  register: kernel_tmp

- name: Copy kernel .deb files to target
  copy:
    src: "{{ item }}"
    dest: "{{ kernel_tmp.path }}/{{ item | basename }}"
    mode: "0644"
  with_fileglob:
    - "{{ kernel_deb_dir }}/*.deb"
  register: copied_debs

- name: Derive kernel version from linux-image .deb filename
  set_fact:
    kernel_version: "{{ (copied_debs.results | map(attribute='dest') | map('basename') | select('match','^linux-image-.*\\.deb$') | list | first | regex_replace('^linux-image-(.+)_.+\\.deb$','\\1')) }}"
  when: copied_debs.results | length > 0

- name: Pre-create overlays directory for Raspberry Pi kernel
  file:
    path: "/usr/lib/linux-image-{{ kernel_version }}/overlays"
    state: directory
    mode: "0755"
  when: kernel_version is defined

- name: Ensure overlays README exists
  copy:
    dest: "/usr/lib/linux-image-{{ kernel_version }}/overlays/README"
    content: |
      This placeholder ensures the Raspberry Pi firmware post-install step succeeds.
    mode: "0644"
  when: kernel_version is defined

- name: Install kernel .deb packages
  apt:
    deb: "{{ item.dest }}"
    state: present
  loop: "{{ copied_debs.results }}"
  loop_control:
    label: "{{ item.dest | basename }}"

- name: Clean up temp directory
  file:
    path: "{{ kernel_tmp.path }}"
    state: absent

- name: Reboot to activate new kernel
  reboot:
    msg: "Rebooting after kernel installation"
    reboot_timeout: 600

- name: Verify running kernel version
  command: uname -r
  register: uname_out
  changed_when: false

- name: Show running kernel
  debug:
    msg: "Running kernel: {{ uname_out.stdout }}"

- name: Assert expected kernel version (optional)
  assert:
    that:
      - kernel_expected_version in uname_out.stdout
    fail_msg: "Expected '{{ kernel_expected_version }}', got '{{ uname_out.stdout }}'"
  when: kernel_expected_version is defined
