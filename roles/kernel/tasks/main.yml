---
- name: Create remote temp directory
  tempfile:
    state: directory
    suffix: kernel
  register: kernel_tmp

- name: Copy kernel .deb files to target
  copy:
    src: "{{ item }}"
    dest: "{{ kernel_tmp.path }}/{{ item | basename }}"
    mode: "0644"
  with_fileglob:
    - "{{ kernel_deb_dir }}/*.deb"
  register: copied_debs

- name: Derive kernel version from linux-image .deb filename
  set_fact:
    kernel_version: "{{ (copied_debs.results | map(attribute='dest') | map('basename') | select('match','^linux-image-.*\\.deb$') | list | first | regex_replace('^linux-image-(.+)_.+\\.deb$','\\1')) }}"

- name: Pre-create overlays directory expected by postinst
  file:
    path: "/usr/lib/linux-image-{{ kernel_version }}/overlays"
    state: directory
    mode: "0755"
  when: kernel_version is defined and kernel_version | length > 0

- name: Ensure overlays README exists
  file:
    path: "/usr/lib/linux-image-{{ kernel_version }}/overlays/README"
    state: touch
    mode: "0644"
  when: kernel_version is defined and kernel_version | length > 0

- name: Install post-install hook to restore overlays README
  copy:
    dest: /etc/kernel/postinst.d/00-ensure-overlays-readme
    mode: "0755"
    content: |
      #!/bin/sh
      set -eu

      version="${1:-}"
      image_dir="/usr/lib/linux-image-${version}"
      overlays_dir="${image_dir}/overlays"

      if [ -z "${version}" ]; then
        exit 0
      fi

      if [ ! -d "${overlays_dir}" ]; then
        mkdir -p "${overlays_dir}"
      fi

      if [ ! -f "${overlays_dir}/README" ]; then
        printf '%s\n' \
          'placeholder README' \
          > "${overlays_dir}/README"
      fi

      exit 0

- name: Install kernel .deb files from remote temp dir
  apt:
    deb: "{{ item.dest }}"
    state: present
  loop: "{{ copied_debs.results }}"
  loop_control:
    label: "{{ item.dest | basename }}"

- name: Clean up remote temp directory
  file:
    path: "{{ kernel_tmp.path }}"
    state: absent
  when: kernel_tmp.path is defined

- name: Update bootloader (Raspberry Pi OS)
  apt:
    name: rpi-eeprom
    state: present
  when: ansible_distribution == 'Raspbian' or ansible_distribution == 'Raspberry Pi OS'

- name: Append cgroup kernel params to cmdline
  replace:
    path: "/boot/firmware/cmdline.txt"
    regexp: "^(.*)$"
    replace: '\\1 cgroup_enable=cpuset cgroup_enable=memory cgroup_memory=1'
    backup: yes
  when: grep_cgroup.rc != 0

- name: Reboot after kernel install
  reboot:
    msg: "Rebooting after kernel installation"
    reboot_timeout: 600

- name: Verify kernel version after reboot
  command: uname -r
  register: uname_out
  changed_when: false

- name: Show running kernel
  debug:
    msg: "Running kernel: {{ uname_out.stdout }}"
