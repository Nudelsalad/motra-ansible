---
- name: Install docker compose plugin
  apt:
    name: docker-compose-plugin
    state: present
    update_cache: yes

- name: Install linux-perf
  apt:
    name: linux-perf
    state: present
    update_cache: yes

- name: Creates ssh directory
  become: true
  file:
    path: "/home/{{ motra_user }}/.ssh"
    state: directory
    owner: "{{ motra_user }}"
    group: "{{ motra_user }}"
    mode: "0700"

- name: Clone motra images repository to user directory
  become: true
  become_user: "{{ motra_user }}"
  git:
    repo: "{{ motra_repo_url }}"
    dest: "{{ motra_user_dir }}"
    accept_hostkey: yes
    version: "{{ motra_version }}"
    force: yes

- name: Install systemd slices from role files
  become: true
  copy:
    src: "systemd/{{ item }}"
    dest: "/etc/systemd/system/{{ item }}"
    mode: "0644"
  loop:
    - isolated.slice
    - workloads.slice

- name: Reload systemd to pick up slice units
  become: true
  systemd:
    daemon_reload: yes

- name: Ensure slices are started
  become: true
  systemd:
    name: "{{ item }}"
    state: started
  loop:
    - isolated.slice
    - workloads.slice

- name: Ensure kernel.perf_event_paranoid is set
  become: true
  sysctl:
    name: kernel.perf_event_paranoid
    value: "-1"
    state: present
    reload: yes
